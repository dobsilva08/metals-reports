name: Silver — Watchdog (Backup de Envio)

on:
  schedule:
    # 09:30 UTC ≙ 06:30 BRT — roda depois do principal (que roda às 06:00 BRT)
    - cron: "30 9 * * *"
  workflow_dispatch:

concurrency:
  group: metals-silver-watchdog
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    env:
      # ===== LLM (padrão: PIAPI) =====
      PIAPI_API_KEY: ${{ secrets.PIAPI_API_KEY }}
      PIAPI_MODEL: gpt-4o-mini

      # Fallbacks (opcionais)
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      GROQ_MODEL: llama-3.1-70b-versatile
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: gpt-4o-mini
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      DEEPSEEK_MODEL: deepseek-chat

      LLM_PROVIDER: piapi
      LLM_FALLBACK_ORDER: piapi,groq,openai,deepseek

      # ===== Telegram =====
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID_METALS: ${{ secrets.TELEGRAM_CHAT_ID_METALS }}
      TELEGRAM_CHAT_ID_TEST: ${{ secrets.TELEGRAM_CHAT_ID_TEST }}
      TELEGRAM_MESSAGE_THREAD_ID: ${{ secrets.TELEGRAM_MESSAGE_THREAD_ID }}

      # ===== Dados (opcionais) =====
      FRED_API_KEY: ${{ secrets.FRED_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: (Opcional) Verificar PiAPI
        if: ${{ env.PIAPI_API_KEY != '' }}
        continue-on-error: true
        run: |
          python scripts/tools/check_piapi.py

      - name: Check main workflow (há envio hoje?)
        id: check_main
        run: |
          python - <<'PY'
import os,sys,json,requests
from datetime import datetime, timezone, timedelta

# --- params: ajuste aqui se o arquivo do workflow principal tem outro nome ---
workflow_file_name = "silver_daily.yml"   # >>> alterar se precisar <<<

repo = os.environ.get("GITHUB_REPOSITORY")
token = os.environ.get("GITHUB_TOKEN")
if not repo or not token:
    print("GITHUB_REPOSITORY or GITHUB_TOKEN not set")
    sys.exit(2)

headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github+json"}

# 1) listar workflows e encontrar o workflow id do arquivo silver_daily.yml
wf_list = requests.get(f"https://api.github.com/repos/{repo}/actions/workflows", headers=headers).json()
wf_id = None
for w in wf_list.get("workflows", []):
    path = w.get("path","")
    if path.endswith(workflow_file_name):
        wf_id = w.get("id")
        break
if not wf_id:
    print("Workflow file not found:", workflow_file_name)
    sys.exit(2)

# 2) buscar runs (últimas 100)
runs = requests.get(f"https://api.github.com/repos/{repo}/actions/workflows/{wf_id}/runs?per_page=100", headers=headers).json()
workflow_runs = runs.get("workflow_runs", [])

# 3) calcular 'hoje' em BRT
BRT_offset = timedelta(hours=-3)
now_utc = datetime.now(timezone.utc)
today_brt = (now_utc + BRT_offset).date()

# 4) procurar qualquer run com conclusion == 'success' e created_at no dia de hoje (em BRT)
found = False
for r in workflow_runs:
    if r.get("conclusion") != "success":
        continue
    created_at = r.get("created_at")  # formato ISO '2025-11-14T09:12:34Z'
    if not created_at:
        continue
    # converter string ISO -> datetime UTC, depois ajustar para BRT
    dt_utc = datetime.fromisoformat(created_at.replace("Z","+00:00"))
    dt_brt = (dt_utc + BRT_offset)
    if dt_brt.date() == today_brt:
        found = True
        break

if found:
    print("FOUND_SUCCESS_TODAY")
    sys.exit(0)   # step success -> will skip watchdog run
else:
    print("NOT_FOUND_SUCCESS_TODAY")
    sys.exit(1)   # step fails -> next step (watchdog) will run
PY

      - name: Rodar Watchdog (executa se não houver envio principal hoje)
        if: ${{ steps.check_main.outcome == 'failure' }}
        run: |
          echo "Nenhum envio bem-sucedido do workflow principal detectado hoje (BRT). Rodando silver_daily.py..."
          python ./scripts/silver_daily.py --send-telegram

      - name: No-op quando já enviado hoje
        if: ${{ steps.check_main.outcome == 'success' }}
        run: |
          echo "Envio principal detectado hoje. Watchdog não executa."
