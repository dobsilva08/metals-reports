name: Watchdog (Gold Daily)

on:
  schedule:
    - cron: "35 09 * * *"   # 09:35 UTC ≈ 06:35 BRT (20 min após o daily)
  workflow_dispatch: {}

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check last run of gold_daily.yml
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const wf = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "gold_daily.yml",
              per_page: 1,
              branch: "main"
            });
            if (!wf.data.workflow_runs.length) {
              core.setFailed("No runs found for gold_daily.yml");
              return;
            }
            const run = wf.data.workflow_runs[0];
            core.setOutput("status", run.status);
            core.setOutput("conclusion", run.conclusion);
            core.setOutput("created_at", run.created_at);
            // Considere "sucesso recente" se foi criado nas últimas 2h e concluiu com success
            const created = new Date(run.created_at).getTime();
            const now = Date.now();
            const twoHours = 2 * 60 * 60 * 1000;
            const fresh = (now - created) <= twoHours;
            if (!(run.conclusion === "success" && fresh)) {
              core.setFailed(`Last run not successful/fresh. status=${run.status} conclusion=${run.conclusion} created_at=${run.created_at}`);
            }

      - name: Telegram alert if missing/failed
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID_ALERTS: ${{ secrets.TELEGRAM_CHAT_ID_ALERTS || secrets.TELEGRAM_CHAT_ID_METALS }}
        run: |
          TEXT="⚠️ Watchdog: gold_daily.yml not successful within the expected window (repo: $GITHUB_REPOSITORY). Check Actions."
          curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID_ALERTS}" \
            -d text="$TEXT"
